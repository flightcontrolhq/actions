name: Docker Setup
description: Setup Docker with buildx and ECR authentication

inputs:
  ecr-registry:
    description: ECR registry URL (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com)
    required: true

  aws-region:
    description: AWS region for ECR
    required: false
    default: us-east-1

  docker-hub-login:
    description: Enable Docker Hub login (requires DOCKER_USERNAME and DOCKER_PASSWORD env vars)
    required: false
    default: "false"

dependencies:
  - name: docker
    checkBinary: docker

  - name: aws-cli
    package: awscli
    checkBinary: aws

instructions:
  # Setup Docker buildx
  - type: command
    command: |
      # Check if buildx is available
      if ! docker buildx version > /dev/null 2>&1; then
        echo "Docker buildx not available, installing..."
        docker run --rm --privileged docker/binfmt:latest --install all
      fi

      # Create or use existing buildx builder
      if ! docker buildx ls | grep -q fc-builder; then
        docker buildx create --use --driver docker-container --name fc-builder --platform linux/amd64,linux/arm64
      else
        docker buildx use fc-builder
      fi

      # Bootstrap the builder
      docker buildx inspect --bootstrap

  # ECR login
  - type: command
    command: |
      echo "Logging into ECR registry: ${{ inputs.ecr-registry }}"
      aws ecr get-login-password --region ${{ inputs.aws-region }} | \
      docker login --username AWS --password-stdin ${{ inputs.ecr-registry }}

  # Optional Docker Hub login
  - type: command
    command: |
      if [ "${{ inputs.docker-hub-login }}" = "true" ]; then
        if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ]; then
          echo "Logging into Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
        else
          echo "Docker Hub login requested but DOCKER_USERNAME or DOCKER_PASSWORD not set"
        fi
      fi
    continueOnError: true