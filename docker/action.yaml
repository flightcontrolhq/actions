name: Docker Setup
description: Setup Docker with buildx and ECR authentication

inputs:
  ecr-registry:
    description: ECR registry URL (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com)
    required: true

  aws-region:
    description: AWS region for ECR
    required: false
    default: us-east-1

  docker-hub-login:
    description: Enable Docker Hub login (requires DOCKER_USERNAME and DOCKER_PASSWORD env vars)
    required: false
    default: "false"

  debug:
    description: Enable debug mode for buildx builder
    required: false
    default: "false"

dependencies:
  - name: docker
    checkBinary: docker
    postInstall:
      - sudo systemctl daemon-reload
      - sudo systemctl start docker
      - sudo systemctl enable docker
      - sudo usermod -aG docker $USER || true

  - name: aws-cli
    package: awscli
    checkBinary: aws

instructions:
  # Setup Docker buildx - remote builder
  - type: command
    command: |
      # Check if buildx is available
      if ! docker buildx version > /dev/null 2>&1; then
        echo "Docker buildx not available, installing..."
        docker run --rm --privileged docker/binfmt:latest --install all
      fi

      # Create remote builder if it doesn't exist
      if ! docker buildx ls | grep -q "fc-builder "; then
        echo "Creating remote builder: fc-builder"
        docker buildx create --name fc-builder --driver=remote --use unix://$HOME/buildkitd.sock
      fi

  # Create buildkitd.toml configuration
  - type: command
    command: |
      cat > ./buildkitd.toml << 'EOF'
      [worker.containerd]
      enabled = false

      [worker.oci]
      max_parallelism = 16
      enabled = true
      gc = true
      snapshotter = "overlayfs"
      cpuset_cpus = "0-14"        # Use CPUs 0 to 14, which is 15 vCPUs
      cpu_quota = 1500000         # Allow 15 vCPUs worth of CPU time every 100 ms
      cpu_period = 100000         # 100 ms period
      cpu_shares = 1024           # Relative weight for CPU time (higher means more priority)
      cpus = 15                   # Limit to 15 vCPUs

      [[worker.oci.gcpolicy]]
        filters = ["type==source.local", "type==exec.cachemount", "type==source.git.checkout"]
        keepBytes = 161061273600  # 85 GB, expressed in bytes

      [[worker.oci.gcpolicy]]
        all = true
        keepBytes = 161061273600  # 85 GB, expressed in bytes
      EOF
      echo "Created buildkitd.toml configuration"

  # Create docker-container builder (normal)
  - type: command
    command: |
      if ! docker buildx ls | grep -q "fc-builder-container "; then
        echo "Creating docker-container builder: fc-builder-container"
        docker buildx create --name fc-builder-container \
          --driver=docker-container \
          --node fc-builder-container \
          --config ./buildkitd.toml
      fi

  # Create docker-container builder (debug)
  - type: command
    command: |
      if ! docker buildx ls | grep -q "fc-builder-container-debug "; then
        echo "Creating docker-container builder: fc-builder-container-debug"
        docker buildx create --name fc-builder-container-debug \
          --driver=docker-container \
          --buildkitd-flags='--debug' \
          --node fc-builder-container-debug \
          --config ./buildkitd.toml
      fi

  # Switch to appropriate builder based on debug flag
  - type: command
    command: |
      if [ "${{ inputs.debug }}" = "true" ]; then
        echo "Using debug builder: fc-builder-container-debug"
        ACTIVE_BUILDER="fc-builder-container-debug"
        INACTIVE_CONTAINER="buildx_buildkit_fc-builder-container"
      else
        echo "Using normal builder: fc-builder-container"
        ACTIVE_BUILDER="fc-builder-container"
        INACTIVE_CONTAINER="buildx_buildkit_fc-builder-container-debug"
      fi

      # Stop the inactive builder's container if it's running
      docker stop "$INACTIVE_CONTAINER" 2>/dev/null || true

      # Use the active builder
      docker buildx use "$ACTIVE_BUILDER"

      # Bootstrap the active builder
      docker buildx inspect --bootstrap

  # ECR login
  - type: command
    command: |
      echo "Logging into ECR registry: ${{ inputs.ecr-registry }}"
      # Set AWS region environment variables for AWS CLI
      export AWS_REGION="${{ inputs.aws-region }}"
      export AWS_DEFAULT_REGION="${{ inputs.aws-region }}"
      aws ecr get-login-password --region "${{ inputs.aws-region }}" | \
      docker login --username AWS --password-stdin "${{ inputs.ecr-registry }}"

  # Optional Docker Hub login
  - type: command
    command: |
      if [ "${{ inputs.docker-hub-login }}" = "true" ]; then
        if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ]; then
          echo "Logging into Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
        else
          echo "Docker Hub login requested but DOCKER_USERNAME or DOCKER_PASSWORD not set"
        fi
      fi
    continueOnError: true
